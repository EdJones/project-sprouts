<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>File: remote_file_target</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html" title="Index">Index</a> &raquo; 
    <span class="title">File: remote_file_target</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><div id='filecontents'>
<p>require ‘digest/md5’</p>

<p>module Sprout</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>RemoteFileTarget</span> <span class='op'>&lt;</span> <span class='const'>FileTarget</span>

  <span class='id attr_accessor'>attr_accessor</span> <span class='symbol'>:archive_type</span>
  <span class='id attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id attr_accessor'>attr_accessor</span> <span class='symbol'>:md5</span>

  <span class='kw'>def</span> <span class='id validate'>validate</span>
    <span class='kw'>super</span>
    <span class='id raise'>raise</span> <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>ValidationError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RemoteFileTarget.url is a required field</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id url'>url</span><span class='period'>.</span><span class='id nil?'>nil?</span>
    <span class='id raise'>raise</span> <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>ValidationError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RemoteFileTarget.md5 is a required field</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id md5'>md5</span><span class='period'>.</span><span class='id nil?'>nil?</span>
    <span class='id raise'>raise</span> <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>ValidationError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RemoteFileTarget.archive_type is a required field</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id archive_type'>archive_type</span><span class='period'>.</span><span class='id nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id resolve'>resolve</span>
    <span class='id validate'>validate</span>
    <span class='id load_unpack_or_ignore_archive'>load_unpack_or_ignore_archive</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'>##
</span>  <span class='comment'># Do not cache this value...
</span>  <span class='comment'>#
</span>  <span class='comment'># This response can change over time IF:
</span>  <span class='comment'>#  - The downloaded bytes do not match the expected MD5
</span>  <span class='comment'>#  - AND the user confirms the prompt that they are OK with this
</span>  <span class='kw'>def</span> <span class='id downloaded_file'>downloaded_file</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id join'>join</span><span class='lparen'>(</span><span class='const'>Sprout</span><span class='period'>.</span><span class='id cache'>cache</span><span class='comma'>,</span> <span class='id pkg_name'>pkg_name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id md5'>md5</span><span class='rbrace'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id archive_type'>archive_type</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id unpacked_file'>unpacked_file</span>
    <span class='id upcased_pkg'>upcased_pkg</span> <span class='op'>=</span> <span class='id pkg_name'>pkg_name</span><span class='period'>.</span><span class='id upcase'>upcase</span>
    <span class='id upcased_version'>upcased_version</span> <span class='op'>=</span> <span class='id pkg_version'>pkg_version</span><span class='period'>.</span><span class='id upcase'>upcase</span><span class='period'>.</span><span class='id gsub'>gsub</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\.</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span>
      <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SPROUT_</span><span class='embexpr_beg'>#{</span><span class='id upcased_pkg'>upcased_pkg</span><span class='rbrace'>}</span><span class='tstring_content'>_</span><span class='embexpr_beg'>#{</span><span class='id upcased_version'>upcased_version</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>||</span>
      <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SPROUT_</span><span class='embexpr_beg'>#{</span><span class='id upcased_pkg'>upcased_pkg</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>||</span>
      <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id upcased_pkg'>upcased_pkg</span><span class='rbrace'>}</span><span class='tstring_content'>_</span><span class='embexpr_beg'>#{</span><span class='id upcased_version'>upcased_version</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>||</span>
      <span class='const'>ENV</span><span class='lbracket'>[</span><span class='id upcased_pkg'>upcased_pkg</span><span class='rbracket'>]</span> <span class='op'>||</span>
      <span class='const'>File</span><span class='period'>.</span><span class='id join'>join</span><span class='lparen'>(</span><span class='const'>Sprout</span><span class='period'>.</span><span class='id cache'>cache</span><span class='comma'>,</span> <span class='id pkg_name'>pkg_name</span><span class='comma'>,</span> <span class='id pkg_version'>pkg_version</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id protected'>protected</span>

  <span class='kw'>def</span> <span class='id logger'>logger</span>
    <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>Log</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id expand_local_path'>expand_local_path</span> <span class='id path'>path</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id join'>join</span> <span class='id unpacked_file'>unpacked_file</span><span class='comma'>,</span> <span class='id path'>path</span>
  <span class='kw'>end</span>

  <span class='id private'>private</span>

  <span class='kw'>def</span> <span class='id load_unpack_or_ignore_archive'>load_unpack_or_ignore_archive</span>
    <span class='kw'>if</span><span class='lparen'>(</span><span class='op'>!</span><span class='id unpacked_files_exist?'>unpacked_files_exist?</span><span class='rparen'>)</span>
      <span class='kw'>if</span><span class='lparen'>(</span><span class='op'>!</span><span class='const'>File</span><span class='period'>.</span><span class='id exists?'>exists?</span><span class='lparen'>(</span><span class='id downloaded_file'>downloaded_file</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id bytes'>bytes</span> <span class='op'>=</span> <span class='id download_archive'>download_archive</span>
        <span class='id write_archive'>write_archive</span> <span class='id bytes'>bytes</span>
      <span class='kw'>end</span>

      <span class='comment'># If we *just* downloaded the file,
</span>      <span class='comment'># use the bytes directly, otherwise
</span>      <span class='comment'># read them off disk from a previous
</span>      <span class='comment'># download attempt:
</span>      <span class='id bytes'>bytes</span> <span class='op'>||=</span> <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='id downloaded_file'>downloaded_file</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rb</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id read'>read</span>

      <span class='kw'>if</span> <span class='id should_unpack?'>should_unpack?</span><span class='lparen'>(</span><span class='id bytes'>bytes</span><span class='comma'>,</span> <span class='id md5'>md5</span><span class='rparen'>)</span>
        <span class='id unpack_archive'>unpack_archive</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id unpacked_files_exist?'>unpacked_files_exist?</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id exists?'>exists?</span><span class='lparen'>(</span><span class='id unpacked_file'>unpacked_file</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='const'>Dir</span><span class='period'>.</span><span class='id empty?'>empty?</span><span class='lparen'>(</span><span class='id unpacked_file'>unpacked_file</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id download_archive'>download_archive</span>
    <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>RemoteFileLoader</span><span class='period'>.</span><span class='id load'>load</span> <span class='id url'>url</span><span class='comma'>,</span> <span class='id pkg_name'>pkg_name</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id write_archive'>write_archive</span> <span class='id bytes'>bytes</span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id mkdir_p'>mkdir_p</span> <span class='const'>File</span><span class='period'>.</span><span class='id dirname'>dirname</span><span class='lparen'>(</span><span class='id downloaded_file'>downloaded_file</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span> <span class='id downloaded_file'>downloaded_file</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb+</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id f'>f</span><span class='op'>|</span>
      <span class='id f'>f</span><span class='period'>.</span><span class='id write'>write</span> <span class='id bytes'>bytes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id should_unpack?'>should_unpack?</span> <span class='id bytes'>bytes</span><span class='comma'>,</span> <span class='id expected_md5sum'>expected_md5sum</span>
    <span class='kw'>if</span> <span class='id expected_md5sum'>expected_md5sum</span>
      <span class='id downloaded_md5'>downloaded_md5</span> <span class='op'>=</span> <span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='period'>.</span><span class='id new'>new</span>
      <span class='id downloaded_md5'>downloaded_md5</span> <span class='op'>&lt;&lt;</span> <span class='id bytes'>bytes</span>

      <span class='kw'>if</span><span class='lparen'>(</span><span class='id expected_md5sum'>expected_md5sum</span> <span class='op'>!=</span> <span class='id downloaded_md5'>downloaded_md5</span><span class='period'>.</span><span class='id hexdigest'>hexdigest</span><span class='rparen'>)</span>
        <span class='kw'>return</span> <span class='id prompt_for_md5_failure'>prompt_for_md5_failure</span> <span class='id downloaded_md5'>downloaded_md5</span><span class='comma'>,</span> <span class='id expected_md5sum'>expected_md5sum</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id prompt_for_md5_failure'>prompt_for_md5_failure</span> <span class='id downloaded_md5'>downloaded_md5</span><span class='comma'>,</span> <span class='id expected_md5sum'>expected_md5sum</span>
    <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The MD5 Sum of the downloaded file (</span><span class='embexpr_beg'>#{</span><span class='id downloaded_md5'>downloaded_md5</span><span class='period'>.</span><span class='id hexdigest'>hexdigest</span><span class='rbrace'>}</span><span class='tstring_content'>) does not match what was expected (</span><span class='embexpr_beg'>#{</span><span class='id expected_md5sum'>expected_md5sum</span><span class='rbrace'>}</span><span class='tstring_content'>).</span><span class='tstring_end'>&quot;</span></span>
    <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Would you like to install anyway? [Yn]</span><span class='tstring_end'>&quot;</span></span>
    <span class='id user_response'>user_response</span> <span class='op'>=</span> <span class='gvar'>$stdin</span><span class='period'>.</span><span class='id gets'>gets</span><span class='period'>.</span><span class='id chomp!'>chomp!</span>
    <span class='kw'>if</span><span class='lparen'>(</span><span class='id user_response'>user_response</span><span class='period'>.</span><span class='id downcase'>downcase</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>y</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>else</span>
      <span class='id raise'>raise</span> <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>RemoteFileLoaderError</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>MD5 Checksum failed</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id unpack_archive'>unpack_archive</span>
    <span class='id logger'>logger</span><span class='period'>.</span><span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unpacking archive at </span><span class='embexpr_beg'>#{</span><span class='id downloaded_file'>downloaded_file</span><span class='rbrace'>}</span><span class='tstring_content'> now. This can take anywhere from a few seconds to many minutes depending on your OS and the size of the archive.\n\nIf you're on windows, consider using this ample time to look into improving the zip utils in Ruby...</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id mkdir_p'>mkdir_p</span> <span class='id unpacked_file'>unpacked_file</span>
    <span class='id unpacker'>unpacker</span> <span class='op'>=</span> <span class='const'>Sprout</span><span class='op'>::</span><span class='const'>ArchiveUnpacker</span><span class='period'>.</span><span class='id new'>new</span>
    <span class='id unpacker'>unpacker</span><span class='period'>.</span><span class='id unpack'>unpack</span> <span class='id downloaded_file'>downloaded_file</span><span class='comma'>,</span> <span class='id unpacked_file'>unpacked_file</span><span class='comma'>,</span> <span class='id archive_type'>archive_type</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>

<p>end</p>
</div></div>
    
    <div id="footer">
  Generated on Tue Dec 21 11:09:49 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.3 (ruby-1.9.2).
</div>

  </body>
</html>